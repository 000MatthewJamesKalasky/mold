option(MOLD_ENABLE_QEMU_TESTS "Enable tests for other targets" OFF)

set(MOLD_ELF_TESTS
  absolute-symbols
  allow-multiple-definition
  ar-alignment
  as-needed2
  as-needed
  as-needed-weak
  auxiliary
  basic
  bno-symbolic
  bsymbolic-functions
  bsymbolic
  bug178
  build-id
  canonical-plt
  cmdline
  color-diagnostics
  comment
  common-archive
  common-ref
  common
  compress-debug-sections
  compressed-debug-info-gnu
  compressed-debug-info
  copyrel-protected
  copyrel-relro
  copyrel
  dead-debug-sections
  debug-macro-section
  default-symver
  defsym
  defsym2
  demangle-rust
  demangle
  dependency-file
  disable-new-dtags
  discard
  dso-undef
  dt-init
  dt-needed
  duplicate-error
  dynamic-dt-debug
  dynamic-linker
  dynamic-list2
  dynamic-list
  dynamic
  emit-relocs
  empty-file
  empty-input
  empty-version
  emulation-deduction
  entry
  exception-mcmodel-large
  exception
  exclude-libs2
  exclude-libs3
  exclude-libs
  execstack-if-needed
  execstack
  export-dynamic
  export-from-exe
  fatal-warnings
  filler
  filter
  func-addr
  gc-sections
  gdb-index-compress-output
  gdb-index-dwarf2
  gdb-index-dwarf3
  gdb-index-dwarf4
  gdb-index-dwarf5
  gdb-index-empty
  glibc-2.22-bug
  gnu-hash
  gnu-linkonce
  gnu-retain
  gnu-unique
  gnu-warning
  hello-dynamic
  hello-static
  help
  hidden-undef
  icf
  icf-small
  ifunc-dso
  ifunc-dynamic
  ifunc-export
  ifunc-static-pie
  ifunc-static
  image-base
  incompatible-libs2
  incompatible-libs
  incompatible-obj
  init-array-priorities
  init-array-readonly
  init-array
  initfirst
  init-in-dso
  init
  interpose
  invalid-version-script
  large-alignment-dso
  large-alignment
  linker-script2
  linker-script3
  linker-script4
  linker-script
  link-order
  lto-archive
  lto-dso
  lto-gcc
  lto-llvm
  lto-version-script
  many-sections
  mergeable-records
  mergeable-strings
  missing-but-ok
  missing-error
  mold-wrapper2
  mold-wrapper
  nocopyreloc
  noinhibit-exec
  non-canonical-plt
  no-quick-exit
  nostdlib
  note2
  note-property
  note
  now
  oformat-binary
  omagic
  package-metadata
  pack-dyn-relocs-relr
  pie
  plt-dso
  pltgot
  plt
  preinit-array
  print-dependencies
  protected-dynsym
  protected
  push-pop-state
  relax
  relocatable-archive
  relocatable
  reloc-overflow
  reloc-rodata
  reloc
  reloc-zero
  relro
  repro
  require-defined
  response-file
  retain-symbols-file
  reverse-sections
  rodata-name
  rosegment
  rpath
  run-clang
  run
  section-alignment
  section-name
  section-start
  shared
  shuffle-sections-seed
  shuffle-sections
  soname
  start-lib
  start-stop-symbol
  static-archive
  static-pie
  stdout
  strip
  symbol-rank
  symbol-version2
  symbol-version3
  symbol-version
  symtab-dso
  symtab-section-symbols
  symtab
  synthetic-symbols
  sysroot2
  sysroot-linker-script
  sysroot
  thin-archive
  thread-count
  tls-common
  tlsdesc-import
  tlsdesc
  tlsdesc-static
  tls-dso
  tls-gd2
  tls-gd-mcmodel-large
  tls-gd-noplt
  tls-gd
  tls-ie
  tls-large-tbss
  tls-ld-mcmodel-large
  tls-ld-noplt
  tls-ld
  tls-le
  tls-module-base
  tls-nopic
  tls-pic
  trace
  trace-symbol
  undefined
  unique
  unresolved-symbols
  verbose
  versioned-undef
  version-script10
  version-script11
  version-script12
  version-script13
  version-script14
  version-script15
  version-script2
  version-script3
  version-script4
  version-script5
  version-script6
  version-script7
  version-script8
  version-script9
  version-script
  version
  visibility
  warn-common
  warn-execstack
  warn-once
  warn-shared-textrel
  warn-textrel
  warn-unresolved-symbols
  weak-export-dso
  weak-export-exe
  weak-undef
  whole-archive
  wrap
  z-cet-report
  z-defs
  z-ibtplt
  z-ibt
  z-max-page-size
  z-nodefaultlib
  z-nodump
  z-now
  z-origin
  z-separate-code
  z-shstk
  z-text
  z-unknown)

function(mold_add_arch_test NAME TRIPLE MACHINE)
  if(NOT ${CMAKE_HOST_SYSTEM_PROCESSOR} STREQUAL ${MACHINE})
    set(TEST_NAME "${MACHINE}-${NAME}")
    add_test(NAME ${TEST_NAME}
      COMMAND bash -x ${CMAKE_CURRENT_LIST_DIR}/${NAME}.sh
      WORKING_DIRECTORY ${mold_BINARY_DIR})

    set(TEST_ENV
      TEST_CC=${TRIPLE}-gcc
      TEST_CXX=${TRIPLE}-g++
      TEST_GCC=${TRIPLE}-gcc
      TEST_GXX=${TRIPLE}-g++
      OBJDUMP=${TRIPLE}-objdump
      MACHINE=${MACHINE}
      "QEMU=qemu-${MACHINE} -L /usr/${TRIPLE}")
    set_tests_properties(${TEST_NAME} PROPERTIES ENVIRONMENT "${TEST_ENV}")
  endif()
endfunction()

foreach(TEST IN LISTS MOLD_ELF_TESTS)
  add_test(NAME "${CMAKE_HOST_SYSTEM_PROCESSOR}-${TEST}"
    COMMAND bash -x ${CMAKE_CURRENT_LIST_DIR}/${TEST}.sh
    WORKING_DIRECTORY ${mold_BINARY_DIR})

  if(MOLD_ENABLE_QEMU_TESTS)
    mold_add_arch_test(${TEST} x86_64-linux-gnu x86_64)
    mold_add_arch_test(${TEST} i686-linux-gnu i386)
    mold_add_arch_test(${TEST} aarch64-linux-gnu aarch64)
    mold_add_arch_test(${TEST} arm-linux-gnueabihf arm)
    mold_add_arch_test(${TEST} riscv64-linux-gnu riscv64)
  endif()
endforeach()
